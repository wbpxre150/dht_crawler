# DHT Crawler Configuration File
# Lines starting with # are comments

# DHT Settings
dht_port=6881

# HTTP API Settings
http_port=8080

# Database Settings
db_path=data/torrents.db

# Logging
# Levels: DEBUG, INFO, WARN, ERROR (or 0, 1, 2, 3)
log_level=INFO

# ==== PHASE 2: Bloom Filter Settings ====
# Reduces database queries by 90% using probabilistic duplicate detection
bloom_enabled=1
bloom_capacity=30000000
bloom_error_rate=0.001
bloom_persist=1
bloom_path=data/bloom.dat

# ==== PHASE 4: Worker Pool Settings ====
# Increases concurrent metadata fetching for 10-20x throughput
scaling_factor=10
metadata_workers=50

# ==== PHASE 5: Batched Database Writes ====
# Improves write performance by 10-100x through transaction batching
batch_writes_enabled=1
batch_size=1000
flush_interval=60

# Meta Data Fetcher
# Maximum concurrent TCP connections per info_hash
# OPTIMIZED: Reduced to 2 to avoid overwhelming peers and network congestion
# With sequential peer fallback, we now try ALL available peers until success
# Lower concurrent value per hash allows better global connection distribution
# and reduces peer rejection rates
concurrent_peers_per_torrent = 5

# Maximum concurrent TCP connections globally (across all infohashes)
# AGGRESSIVE: High limit to maximize throughput across all torrents
max_concurrent_connections = 5000

# TCP connection establishment timeout in seconds
# This timeout applies only during the TCP connection phase (before handshake)
# Should be shorter than idle timeout since connection should establish quickly
# Recommendation: 10s for most cases, 15s for very slow networks
tcp_connect_timeout_sec = 10

# Connection IDLE timeout in seconds (ACTIVITY-BASED - resets on data reception)
# Connection will close if NO DATA is received for this duration
# Timer resets whenever any data is received, allowing slow transfers to complete
# Previous: 4s total connection time (too aggressive - caused 74% timeout rate)
# New: 30s idle timeout (generous for slow peers, but prevents truly stalled connections)
# Recommendation: 30-60s for most cases, higher for very slow networks
connection_timeout_sec = 30

# Maximum total connection lifetime in seconds (0 = unlimited)
# Hard limit to prevent connections from staying open indefinitely
# This applies even if connection is actively receiving data
# Prevents edge cases where malicious/broken peers drip-feed data forever
# Recommendation: 60s is sufficient for most metadata transfers (<10MB typical)
# Set to 0 to rely only on idle timeout (not recommended)
max_connection_lifetime_sec = 60

# Maximum metadata size in MB (reject larger)
max_metadata_size_mb = 100

# ==== wbpxre-dht Settings ====
# New DHT library with multi-threaded architecture and full BEP 51 support
wbpxre_ping_workers=50
wbpxre_find_node_workers=20
wbpxre_sample_infohashes_workers=180
wbpxre_get_peers_workers=3500
wbpxre_query_timeout=4

# Maximum nodes in routing table (default: 10000)
# Higher values improve DHT coverage but use more memory (~200 bytes per node)
# OPTIMIZED: 60000 nodes provides headroom for rotation (90% = 54K triggers eviction)
# 60000 nodes ≈ 12 MB memory
# FIX: Increased from 50K to 60K to reduce eviction pressure after rotation
max_routing_table_nodes=80000

# ==== Node ID Rotation Settings ====
# Periodically change node ID to explore different DHT keyspace regions
# This increases metadata discovery by moving to different parts of the network
# HOT ROTATION MODE: Preserves routing table and keeps workers running (NO DOWNTIME!)
# - Eliminates ~120 second bootstrap penalty per rotation
# - Maintains 6,500+ routing table nodes across rotations
# - Three-phase transition: STABLE -> ANNOUNCING -> TRANSITIONING -> STABLE
# - Expected 3-4x improvement in discovery rate vs destructive rotation
# OPTIMIZED: 300s (5 min) rotation with aggressive post-rotation pruning
node_rotation_enabled=1
node_rotation_interval_sec=15         # Rotate every 30 seconds
rotation_phase_duration_sec=15        # Duration (in seconds) for ANNOUNCING and TRANSITIONING phases
clear_sample_queue_on_rotation=1      # Clear sample_infohashes queue on rotation (0=keep, 1=clear)
                                      # Clearing helps focus on new keyspace, keeping preserves in-flight work

# ==== Peer Discovery Retry Settings ====
# Retry get_peers queries multiple times to discover more peers before metadata fetch
# This dramatically improves metadata fetch success rates (5-15% → 25-40%)
# Each retry queries K=8 different DHT nodes, accumulating more peers
# The get_peers worker exits after finding just 1 peer, so retries are essential
peer_retry_enabled=1
peer_retry_max_attempts=4        # Query DHT up to 4 times per info_hash
peer_retry_min_threshold=10      # Stop retrying if we have 10+ peers
peer_retry_delay_ms=777          # Wait 500ms between retry attempts

# ==== Dual Routing Table Settings ====
# Uses two rotating routing tables to eliminate race conditions during node removal
# Table A fills to 80%, then Table B starts filling
# When Table B reaches 20%, it becomes the active table and Table A is cleared
# This approach eliminates all individual node removal operations during runtime

# Threshold to start filling secondary table (0.0-1.0, default: 0.80)
# When primary table reaches this capacity, start inserting into secondary table
dual_routing_fill_threshold=0.80

# Threshold to switch active table (0.0-1.0, default: 0.20)
# When secondary table reaches this capacity, make it the new active table
dual_routing_switch_threshold=0.20

# How often to check for rotation (seconds, default: 5)
dual_routing_check_interval_sec=5

# ==== Pornography Content Filter ====
# Hybrid 3-layer filtering system for detecting pornographic content
# - Layer 1: Hash set keyword matching (fast pre-filter)
# - Layer 2: Regex pattern matching for evasion detection
# - Layer 3: Heuristic scoring based on multiple signals
# Expected performance: 2-7ms per torrent, 85-92% accuracy

# Enable/disable the filter (0=disabled, 1=enabled)
porn_filter_enabled=1

# Path to keyword file (relative or absolute)
porn_filter_keyword_file=porn_filter_keywords.txt

# Minimum weight for keyword match to trigger filter (1-10, default: 8)
# Higher = fewer false positives, lower = catches more variations
# OPTIMIZED: Raised to 9 to reduce false positives from generic terms
porn_filter_keyword_threshold=9

# Minimum weight for regex pattern match to trigger filter (1-10, default: 9)
# Regex patterns detect evasion techniques (l33tspeak, etc.)
porn_filter_regex_threshold=10

# Minimum heuristic score to trigger filter (0-20, default: 5)
# Heuristic scoring considers file types, naming patterns, etc.
# OPTIMIZED: Raised to 7 to reduce false positives from normal video content
porn_filter_heuristic_threshold=7
