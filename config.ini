# DHT Crawler Configuration File
# Lines starting with # are comments

# DHT Settings
dht_port=6881

# HTTP API Settings
http_port=8080

# Database Settings
db_path=data/torrents.db

# Logging
# Levels: DEBUG, INFO, WARN, ERROR (or 0, 1, 2, 3)
log_level=DEBUG

# ==== PHASE 2: Bloom Filter Settings ====
# Reduces database queries by 90% using probabilistic duplicate detection
bloom_enabled=1
bloom_capacity=30000000
bloom_error_rate=0.001
bloom_persist=1
bloom_path=data/bloom.dat

# ==== PHASE 4: Worker Pool Settings ====
# Increases concurrent metadata fetching for 10-20x throughput
scaling_factor=10
metadata_workers=200

# ==== PHASE 5: Batched Database Writes ====
# Improves write performance by 10-100x through transaction batching
batch_writes_enabled=1
batch_size=1000
flush_interval=60

# Meta Data Fetcher
# Maximum concurrent TCP connections globally (across all infohashes)
# Each infohash now uses sequential peer attempts (1 at a time) to avoid race conditions
# This limit controls how many different infohashes can be fetched concurrently
max_concurrent_connections = 5000

# TCP connection establishment timeout in seconds
# This timeout applies only during the TCP connection phase (before handshake)
# Should be shorter than idle timeout since connection should establish quickly
# Recommendation: 10s for most cases, 15s for very slow networks
tcp_connect_timeout_sec = 10

# Connection IDLE timeout in seconds (ACTIVITY-BASED - resets on data reception)
# Connection will close if NO DATA is received for this duration
# Timer resets whenever any data is received, allowing slow transfers to complete
# Previous: 4s total connection time (too aggressive - caused 74% timeout rate)
# New: 30s idle timeout (generous for slow peers, but prevents truly stalled connections)
# Recommendation: 30-60s for most cases, higher for very slow networks
connection_timeout_sec = 30

# Maximum total connection lifetime in seconds (0 = unlimited)
# Hard limit to prevent connections from staying open indefinitely
# This applies even if connection is actively receiving data
# Prevents edge cases where malicious/broken peers drip-feed data forever
# Recommendation: 60s is sufficient for most metadata transfers (<10MB typical)
# Set to 0 to rely only on idle timeout (not recommended)
max_connection_lifetime_sec = 60

# Maximum metadata size in MB (reject larger)
max_metadata_size_mb = 100

# ==== wbpxre-dht Settings ====
# New DHT library with multi-threaded architecture and full BEP 51 support
wbpxre_ping_workers=40
wbpxre_find_node_workers=200
wbpxre_sample_infohashes_workers=250
wbpxre_get_peers_workers=5000
wbpxre_query_timeout=3

# ==== Peer Discovery Retry Settings ====
# Retry get_peers queries multiple times to discover more peers before metadata fetch
# This dramatically improves metadata fetch success rates (5-15% â†’ 25-40%)
# Each retry queries K=8 different DHT nodes, accumulating more peers
# The get_peers worker exits after finding just 1 peer, so retries are essential
peer_retry_enabled=1
peer_retry_max_attempts=3        # Query DHT up to 4 times per info_hash
peer_retry_min_threshold=10      # Stop retrying if we have 10+ peers
peer_retry_delay_ms=300          # Wait 500ms between retry attempts
peer_retry_cleanup_interval_sec=30  # How often to cleanup stale entries (>60s old)
peer_retry_max_entries=10000     # Maximum entries before oldest is evicted

# ==== Triple Routing Table Settings ====
# Uses three rotating routing tables to eliminate race conditions and solve bootstrap problem
# - FILLING table: find_node workers insert discovered nodes here
# - STABLE table: sample_infohashes and DHT queries read from here
# - IDLE table: waiting to become the next filling table
# Key benefits:
# - Solves bootstrap problem: stable table available after first rotation (~30-60s)
# - No race conditions: strict read/write separation
# - Always have nodes for DHT queries (after bootstrap)

# Rotation threshold: trigger rotation when filling table reaches this count (default: 1500)
# Lower = faster bootstrap but more frequent rotations
# Higher = slower bootstrap but fewer rotations
# Recommended range: 1000-2000 nodes
triple_routing_threshold=10000

# Rotation time: minimum time between rotations in seconds (default: 60)
# Prevents thrashing when tables fill rapidly after bootstrap
# Also serves as the node ID rotation interval for keyspace coverage
# Lower = more keyspace exploration but more queue clearing overhead
# Higher = more stable keyspace but less exploration
# Recommended range: 60-600 seconds (1-10 minutes)
triple_routing_rotation_time=30

# ==== Pornography Content Filter ====
# Hybrid 3-layer filtering system for detecting pornographic content
# - Layer 1: Hash set keyword matching (fast pre-filter)
# - Layer 2: Regex pattern matching for evasion detection
# - Layer 3: Heuristic scoring based on multiple signals
# Expected performance: 2-7ms per torrent, 85-92% accuracy

# Enable/disable the filter (0=disabled, 1=enabled)
porn_filter_enabled=1

# Path to keyword file (relative or absolute)
porn_filter_keyword_file=porn_filter_keywords.txt

# Minimum weight for keyword match to trigger filter (1-10, default: 8)
# Higher = fewer false positives, lower = catches more variations
# OPTIMIZED: Raised to 9 to reduce false positives from generic terms
porn_filter_keyword_threshold=9

# Minimum weight for regex pattern match to trigger filter (1-10, default: 9)
# Regex patterns detect evasion techniques (l33tspeak, etc.)
porn_filter_regex_threshold=10

# Minimum heuristic score to trigger filter (0-20, default: 5)
# Heuristic scoring considers file types, naming patterns, etc.
# OPTIMIZED: Raised to 7 to reduce false positives from normal video content
porn_filter_heuristic_threshold=7

use_thread_trees = 1
num_trees = 4
tree_metadata_workers = 2
min_metadata_rate = 0.5

# Thread tree bootstrap settings (Stage 2)
# Timeout for bootstrap phase in seconds (default: 30)
tree_bootstrap_timeout_sec = 30
# Number of routing table nodes required before transitioning to BEP51 phase (default: 200)
# Lowered from 500 to make bootstrap faster. Range: 100-1000
tree_routing_threshold = 200
